version: '3.8'

services:
  app:
    build: .
    ports:
      - "${PORT:-5003}:${PORT_INTERNAL:-5002}"
    environment:
      - PORT=${PORT_INTERNAL:-5002}
      - MONGO_URI=${MONGO_URI:-mongodb://mongo:27017/ssex}
      - REDIS_URL=${REDIS_URL:-redis://redis:6379}
      - MINIO_ENDPOINT=${MINIO_ENDPOINT:-minio}
      - MINIO_PORT=${MINIO_PORT:-9000}
      - MINIO_ACCESS_KEY=${MINIO_ACCESS_KEY:-minioadmin}
      - MINIO_SECRET_KEY=${MINIO_SECRET_KEY:-minioadmin}
      - MINIO_BUCKET=${MINIO_BUCKET:-ssex-images}
      - JWT_SECRET=${JWT_SECRET:-your_production_secret}
      - ADMIN_EMAIL=${ADMIN_EMAIL:-admin@admin.com}
      - ADMIN_PASSWORD=${ADMIN_PASSWORD:-your_secure_password}
      - NODE_ENV=production
    depends_on:
      - mongo
      - redis
      - minio
    restart: always

  mongo:
    image: mongo:latest
    ports:
      - "${MONGO_PORT:-27018}:27017"
    volumes:
      - mongo-data:/data/db
    restart: always

  redis:
    image: redis:alpine
    ports:
      - "${REDIS_PORT:-6379}:6379"
    volumes:
      - redis-data:/data
    restart: always

  minio:
    image: minio/minio
    ports:
      - "${MINIO_API_PORT:-9000}:9000"
      - "${MINIO_CONSOLE_PORT:-9001}:9001"
    environment:
      MINIO_ROOT_USER: ${MINIO_ACCESS_KEY:-minioadmin}
      MINIO_ROOT_PASSWORD: ${MINIO_SECRET_KEY:-minioadmin}
    volumes:
      - minio-data:/data
    command: server /data --console-address ":9001"
    restart: always

  createbuckets:
    image: minio/mc
    depends_on:
      - minio
    entrypoint: >
      /bin/sh -c "
      /usr/bin/mc config host add myminio http://minio:9000 ${MINIO_ACCESS_KEY:-minioadmin} ${MINIO_SECRET_KEY:-minioadmin};
      /usr/bin/mc mb myminio/${MINIO_BUCKET:-ssex-images};
      /usr/bin/mc anonymous set public myminio/${MINIO_BUCKET:-ssex-images};
      exit 0;
      "

volumes:
  mongo-data:
  redis-data:
  minio-data:
